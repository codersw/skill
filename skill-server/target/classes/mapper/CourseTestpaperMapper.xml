<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skill.server.mapper.CourseTestpaperMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.skill.server.entity.pojo.CourseTestpaper">
        <id column="paperid" property="paperid" />
        <result column="papernum" property="papernum" />
        <result column="type" property="type" />
        <result column="status" property="status" />
        <result column="num" property="num" />
        <result column="ctime" property="ctime" />
        <result column="utime" property="utime" />
        <result column="isdel" property="isdel" />
        <result column="level" property="level" />
        <result column="price" property="price" />
        <result column="ischarge" property="ischarge" />
        <result column="count" property="count" />
        <result column="gradeid" property="gradeid" />
        <result column="subjectid" property="subjectid" />
        <result column="papertitle" property="papertitle" />
        <result column="istest" property="istest" />
        <result column="memo" property="memo" />
        <result column="fullmark" property="fullmark" />
        <result column="teststarttime" property="teststarttime" />
        <result column="examinationendtime" property="examinationendtime" />
    </resultMap>

    <!--自定义查询结果-->
    <resultMap id="BaseResultMapVo" type="com.skill.server.entity.vo.StudentCourseTestpaperVo" extends="BaseResultMap">
        <result column="id" property="id"/>
        <result column="paperstats" property="paperstats"/>
        <result column="coursetitle" property="coursetitle"/>
        <result column="itemtitle" property="itemtitle"/>
        <result column="subjectname" property="subjectname"/>
        <result column="accuracy" property="accuracy"/>
        <result column="status" property="status"/>
        <result column="alone" property="alone"/>
        <result column="rightnum" property="rightnum"/>
        <result column="failnum" property="failnum"/>
        <result column="display" property="display"/>
        <result column="fixedtime" property="fixedtime"/>
    </resultMap>

    <!--自定义查询结果-->
    <resultMap id="BaseResultListMapVo" type="com.skill.server.entity.vo.StudentCourseTestpaperVo" extends="BaseResultMap">
        <result column="alonepack" property="alonepack"/>
        <result column="alone" property="alone"/>
        <result column="acitveid" property="acitveid"/>
        <result column="priceback" property="priceback"/>
        <result column="fold" property="fold"/>
        <result column="memo" property="memo"/>
        <result column="actuvetitle" property="actuvetitle"/>
    </resultMap>

    <!--教师获取习题列表结果-->
    <resultMap id="TeacherCourseTestpaperListVo" type="com.skill.server.entity.vo.TeacherCourseTestpaperListVo" extends="BaseResultMap">
        <result column="subjectname" property="subjectname"/>
        <result column="courseid" property="courseid"/>
        <result column="coursetitle" property="coursetitle"/>
        <result column="gradename" property="gradename"/>
        <result column="practicenum" property="practicenum"/>
        <result column="introduce" property="introduce"/>
        <result column="itemid" property="itemid"/>
        <result column="itemtitle" property="itemtitle"/>
        <result column="fixedtime" property="fixedtime"/>
        <result column="unmarknum" property="unmarknum"/>
    </resultMap>


    <!--教师获取审核列表结果-->
    <resultMap id="TeacherCourseCheckTestpaperListVo" type="com.skill.server.entity.vo.TeacherCourseCheckTestpaperListVo" extends="BaseResultMap">
        <result column="itemid" property="itemid"/>
    </resultMap>
    
    <!--自定义查询结果（考试试卷列表）-->
    <resultMap id="Testperexamination" type="com.skill.server.entity.vo.TestperExaminationVo" extends="BaseResultMap">
        <result column="subjectname" property="subjectname"/>
        <result column="status" property="status"/>
        <result column="fraction" property="fraction"/>
        <result column="num" property="num"/>
        <result column="kscore" property="kscore"/>
        <result column="zscore" property="zscore"/>
        <result column="adscore" property="adscore"/>
    </resultMap>


    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        paperid, papernum, type, status, num, ctime, utime, isdel, `level`, price, ischarge, `count`, gradeid, subjectid, papertitle
    </sql>

    <!--获取购买次数-->
    <select id="studentCourseItmeTestpapercount" resultType="int">
        SELECT `count` from ck_course_testpaper
        <where>
            paperid=#{paperid}
        </where>
    </select>

    <!--获取列表-->
    <select id="selectpaperIPagelist" resultMap="BaseResultMapVo">
        SELECT
            cct.paperid,
            cct.papertitle,
            cct.ischarge,
            cct.price,
            IFNULL(ccd.id,'') alone,
            IFNULL(a.id, '') alonepack,
            ccts.`status`,
            IFNULL(ccts.num,'0') num,
            b.count,
            case when DATE(cci.fixedtime)>DATE(NOW()) then '0' else '1' end display
        FROM
            ck_course_testpaper cct
        INNER JOIN ck_course_item_testpaper ccit ON cct.paperid = ccit.paperid AND cct.isdel='0' AND cct.`status`='1' AND cct.istest='0'
        LEFT JOIN ck_capital_detail ccd ON ccd.paperid=cct.paperid
        AND ccd.studentid=#{StudentcourseTestpaperCo.studentid} AND ccd.coursepaytype='0'
        LEFT JOIN ck_course_testpaper_student ccts ON ccts.paperid=cct.paperid
        AND ccts.studentid=#{StudentcourseTestpaperCo.studentid}
        INNER JOIN ck_course_item cci ON ccit.itemid=cci.itemid
        INNER JOIN (
        SELECT COUNT(1) count,paperid FROM ck_course_item_practice  GROUP BY paperid
        ) b ON b.paperid=cct.paperid
        LEFT JOIN (
            SELECT
            cca.acitveid,
            cta.paperid,
            cta.activenum,
            ccd.id,
            ccd.studentid
            FROM
            ck_course_item_testpaper_active cta
            INNER JOIN ck_course_active cca ON cta.activenum=cca.activenum AND cta.type = '1'
            LEFT JOIN ck_capital_detail ccd ON ccd.paperid = cca.acitveid
            AND ccd.coursepaytype = '2' AND ccd.studentid =#{StudentcourseTestpaperCo.studentid}
        ) a ON a.paperid = cct.paperid
        WHERE
        <if test="StudentcourseTestpaperCo.courseid != null and StudentcourseTestpaperCo.courseid != ''">
             ccit.courseid=#{StudentcourseTestpaperCo.courseid}
        </if>
        <if test="StudentcourseTestpaperCo.itemid != null and StudentcourseTestpaperCo.itemid != ''">
            and ccit.itemid=#{StudentcourseTestpaperCo.itemid}
        </if>
        ORDER BY
            cci.fixedtime ASC,
            cct.`level` ASC
    </select>

    <!-- 获取试卷集合-->
    <select id="teacherCourseTestpaperList" resultMap="TeacherCourseTestpaperListVo">
        SELECT
            ct.paperid,
            any_value(ct.papernum) papernum,
            any_value(ct.type) type,
            any_value(ct.`status`) `status`,
            any_value(ct.num) num,
            any_value(ct.ctime) ctime,
            any_value(ct.utime) utime,
            any_value(ct.isdel) isdel,
            any_value(ct.`level`) `level`,
            any_value(ct.price) price,
            any_value(ct.ischarge) ischarge,
            any_value(ct.count) count,
            any_value(ct.gradeid) gradeid,
            any_value(ct.subjectid) subjectid,
            any_value(ct.papertitle) papertitle,
            any_value(ct.istest) istest,
            any_value(ct.pronunciation) pronunciation,
            any_value(ct.fullmark) fullmark,
            any_value(ct.memo) memo,
            any_value(cs.subjectname) subjectname,
            any_value(c.courseid) courseid,
            any_value(c.coursetitle) coursetitle,
            any_value(sg.gradename) gradename,
            any_value(ci.itemid) itemid,
            any_value(ci.itemtitle) itemtitle,
            any_value(ci.fixedtime) fixedtime,
            ifnull(a.unmarknum, '0') unmarknum
        FROM ck_course_testpaper ct
        INNER JOIN ck_course_item_testpaper cit ON cit.paperid = ct.paperid AND ct.isdel = '0' AND ct.status = '1'
        INNER JOIN ck_course_item ci ON ci.itemid = cit.itemid AND ci.isdel = '0' AND ci.status = '1'
        INNER JOIN ck_course c ON c.courseid = ci.courseid AND c.isdel = '0' AND c.istop = '1'
        INNER JOIN ck_course_subject cs ON cs.subjectid = c.subjectid AND cs.status = '1'
        INNER JOIN ck_school_grade sg ON sg.gradeid = c.gradeid
        INNER JOIN ck_course_item_practice cip ON cip.paperid = ct.paperid AND cip.isdel = '0' AND cip.status = '1'
        INNER JOIN ck_course_school ccs ON ccs.courseid = c.courseid AND ccs.schoolid = #{courseTestpaperListCo.schoolid}
        INNER JOIN (select gradeid from ck_school_class where schoolid = #{courseTestpaperListCo.schoolid} group by gradeid) d on d.gradeid = ci.gradeid
        <if test="courseTestpaperListCo.teacherid != null and courseTestpaperListCo.teacherid != ''">
            inner join (select teacherid,gradeid,schoolid, classid from ck_teach WHERE teacherid = #{courseTestpaperListCo.teacherid} group by teacherid,gradeid ) b
            on b.gradeid = ci.gradeid
            INNER JOIN ck_teacher_subject ts ON ts.teacherid = b.teacherid
            AND ts.subjectid = ci.subjectid
        </if>
        LEFT JOIN (
            SELECT
            count( 1 ) AS unmarknum,
            cts.paperid,
            any_value ( ss.grade ) gradeid
            FROM
            ck_course_testpaper_student cts
            INNER JOIN ck_school_studentinfo ss ON ss.studentid = cts.studentid
            AND cts.`status` = '1' AND ss.schoolid = #{courseTestpaperListCo.schoolid}
            INNER JOIN ck_teach t on t.classid = ss.studentclass and t.schoolid = ss.schoolid
            <if test="courseTestpaperListCo.teacherid != null and courseTestpaperListCo.teacherid != ''">
                and t.teacherid = #{courseTestpaperListCo.teacherid}
            </if>
            GROUP BY
            cts.paperid
        ) a ON a.paperid = ct.paperid AND a.gradeid = ct.gradeid
        <where>
            1=1
            <if test="courseTestpaperListCo.keyword != null and courseTestpaperListCo.keyword !=''">
                and ct.papertitle LIKE CONCAT('%',#{courseTestpaperListCo.keyword},'%')
            </if>
            <if test="courseTestpaperListCo.subjectid != null and courseTestpaperListCo.subjectid !=''">
                and c.subjectid = #{courseTestpaperListCo.subjectid}
            </if>
            <if test="courseTestpaperListCo.gradeid != null and courseTestpaperListCo.gradeid !=''">
                and ct.gradeid = #{courseTestpaperListCo.gradeid}
            </if>
            <if test="courseTestpaperListCo.level != null and courseTestpaperListCo.level !=''">
                and ct.level = #{courseTestpaperListCo.level}
            </if>
            <if test="courseTestpaperListCo.startDate != null and courseTestpaperListCo.startDate != '' and courseTestpaperListCo.endDate != null and courseTestpaperListCo.endDate != ''">
                and DATE(ci.fixedtime) between #{courseTestpaperListCo.startDate} and #{courseTestpaperListCo.endDate}
            </if>
        </where>
        GROUP BY ct.paperid
        ORDER BY ci.fixedtime, ct.`level`
    </select>

    <!--学生有关试卷列表 -->
    <select id="selectCourseTestpaperByStudent" resultMap="BaseResultMapVo">
        SELECT
            ct.paperid,
            any_value ( ct.papertitle ) papertitle,
            any_value ( c.coursetitle ) coursetitle,
            any_value ( ci.itemtitle ) itemtitle,
            any_value ( ct.price ) price,
            any_value ( ct.ischarge ) ischarge,
            IFNULL( any_value ( cts.`status` ), '-1' ) status,
            any_value ( ct.utime ) utime,
            IFNULL( any_value ( cts.num ), '0' ) num,
            IFNULL( any_value ( cd.id ), '' ) alone,
            any_value ( ci.fixedtime ) fixedtime,
            CASE WHEN any_value ( DATE( ci.fixedtime ) ) > DATE( NOW( ) ) THEN '0' ELSE '1' END display
            FROM
            ck_course_testpaper ct
            INNER JOIN ck_course_item_testpaper cit ON ct.paperid = cit.paperid
            AND ct.isdel = '0'
            AND ct.`status` = '1'
            and ct.istest='0'
            AND ct.gradeid = #{StudentcourseTestpaperCo.gradeid}
            <if test="StudentcourseTestpaperCo.subjectid != null and StudentcourseTestpaperCo.subjectid !=''">
                and ct.subjectid = #{StudentcourseTestpaperCo.subjectid}
            </if>
            <if test="StudentcourseTestpaperCo.papertitle != null and StudentcourseTestpaperCo.papertitle !=''">
                and ct.papertitle LIKE CONCAT('%',#{StudentcourseTestpaperCo.papertitle},'%')
            </if>
            LEFT JOIN ck_course_testpaper_student cts ON ct.paperid = cts.paperid
            AND cts.studentid = #{StudentcourseTestpaperCo.studentid}
            INNER JOIN ck_course_item ci ON cit.itemid = ci.itemid
            AND ci.isdel = '0'
            AND ci.status = '1'
            <if test="StudentcourseTestpaperCo.ctime != null and StudentcourseTestpaperCo.ctime !=''">
                and ci.fixedtime LIKE CONCAT('%',#{StudentcourseTestpaperCo.ctime},'%')
            </if>
            INNER JOIN ck_course c ON c.courseid = ci.courseid
            AND c.isdel = '0'
            LEFT JOIN ck_capital_detail cd ON cd.paperid = ct.paperid
            AND cd.coursepaytype = '0'
            AND cd.studentid = #{StudentcourseTestpaperCo.studentid}
            GROUP BY
            ct.paperid
            ORDER BY IFNULL(cts.`status`, '-1') + 0 DESC,cts.ctime DESC,ci.fixedtime ASC,ct.ctime ASC
    </select>

    <!--学生已做试卷列表 -->
    <select id="selectCourseTestpaperAll" resultMap="BaseResultMapVo">
       SELECT
            ct.paperid,
            ct.papertitle,
            cs.subjectname,
            cs.subjectid,
            cts.`status`,
            cts.ctime,
            cts.num
        FROM
            ck_course_testpaper_student cts
            INNER JOIN ck_course_testpaper ct ON cts.paperid = ct.paperid and cts.studentid = #{StudentcourseTestpaperCo.studentid}
            AND ct.isdel = '0'
            AND ct.STATUS = '1'
            and ct.istest='0'
            INNER JOIN ck_course_subject cs ON ct.subjectid = cs.subjectid
            AND cs.STATUS = '1'
        ORDER BY
            cts.ctime DESC,
            cts.status + 0 DESC
    </select>

    <select id="selectCourseTestpaperNum" resultType="map">
        SELECT
            sum( CASE WHEN cipa.iscorrect = '1' THEN 1 ELSE 0 END ) rightnum,
            sum( CASE WHEN cipa.iscorrect = '0' THEN 1 ELSE 0 END ) failnum,
            cip.paperid
        FROM
            ck_course_item_practice_answer cipa
            INNER JOIN ck_course_item_practice cip ON cip.practiceid = cipa.practiceid
            AND cipa.studentid = #{studentid}
            <if test="ids.size() > 0">
                AND cip.paperid in
                <foreach item="id" collection="ids" separator="," open="(" close=")" index="">
                    #{id}
                </foreach>
            </if>
        GROUP BY
            cip.paperid
    </select>


    <!--课程试卷列表 -->
    <select id="selectTestpaperList" resultMap="BaseResultMapVo">
        SELECT
            cct.paperid,
            cct.papertitle coursetitle,
            cct.price,
            cct.ischarge,
            ccts.`status`,
            IFNULL(ccts.num,'0') num,
            IFNULL(ccd.id,'') alone,
            IFNULL(a.id,'') alonepack,
            b.count,
            case when DATE(cci.fixedtime)>DATE(NOW()) then '0' else '1' end display
        FROM
            ck_course_item_testpaper ccit
            INNER JOIN ck_course_testpaper cct ON ccit.paperid = cct.paperid and cct.isdel = '0' and cct.status='1' and cct.istest='0'
            INNER JOIN ck_course_item cci ON ccit.itemid=cci.itemid
            INNER JOIN ck_course_school ccs ON ccs.courseid = ccit.courseid and ccs.schoolid = #{StudentcourseTestpaperCo.schoolid}
            LEFT JOIN ck_course_testpaper_student ccts ON ccts.paperid=cct.paperid
            AND ccts.studentid=#{StudentcourseTestpaperCo.studentid}
            LEFT JOIN ck_capital_detail ccd ON ccd.paperid=cct.paperid
            AND ccd.coursepaytype='0'
            AND ccd.studentid=#{StudentcourseTestpaperCo.studentid}
            INNER JOIN (
            SELECT COUNT(1) count,paperid FROM ck_course_item_practice  GROUP BY paperid
            ) b ON b.paperid=cct.paperid
            LEFT JOIN (
                SELECT
                cca.acitveid,
                cta.paperid,
                cta.activenum,
                ccd.id,
                ccd.studentid
                FROM
                ck_course_item_testpaper_active cta
                INNER JOIN ck_course_active cca ON cta.activenum=cca.activenum AND cta.type = '1'
                LEFT JOIN ck_capital_detail ccd ON ccd.paperid = cca.acitveid
                AND ccd.coursepaytype = '2' and ccd.studentid=#{StudentcourseTestpaperCo.studentid}
            ) a ON a.paperid = cct.paperid
        <where>
            1=1
            <if test="StudentcourseTestpaperCo.coursetitle != null and StudentcourseTestpaperCo.coursetitle !=''">
                and cct.papertitle LIKE CONCAT('%',#{StudentcourseTestpaperCo.coursetitle},'%')
            </if>
            <if test="StudentcourseTestpaperCo.gradeid != null and StudentcourseTestpaperCo.gradeid !=''">
                and cct.gradeid = #{StudentcourseTestpaperCo.gradeid}
            </if>
            <if test="StudentcourseTestpaperCo.subjectid != null and StudentcourseTestpaperCo.subjectid !=''">
                and cct.subjectid = #{StudentcourseTestpaperCo.subjectid}
            </if>
            ORDER BY
                cci.fixedtime ASC
        </where>

    </select>

    <select id="selectTestpaper" resultMap="BaseResultMapVo">
        SELECT
        cct.paperid,
        cct.papertitle coursetitle,
        cct.price,
        cct.ischarge,
        ccts.`status`,
        IFNULL(ccts.num,'0') num,
        IFNULL(ccd.id,'') alone
        FROM
        ck_course_item_testpaper ccit
        INNER JOIN ck_course_testpaper cct ON ccit.paperid = cct.paperid
        INNER JOIN ck_course_school ccs ON ccs.courseid = ccit.courseid
        LEFT JOIN ck_course_testpaper_student ccts ON ccts.paperid=cct.paperid
        AND ccts.studentid=#{StudentcourseTestpaperCo.studentid}
        LEFT JOIN ck_capital_detail ccd ON ccd.paperid=cct.paperid
        AND ccd.studentid=#{StudentcourseTestpaperCo.studentid} AND ccd.coursepaytype='0'
        <where>
            cct.isdel='0'
                and cct.paperid=#{StudentcourseTestpaperCo.paperid}
        </where>

    </select>

    <!--提高题总数量（年级） -->
    <select id="selectLevelCount" resultType="int">
        SELECT
            count(1) `count`
        FROM
            ck_course_testpaper cct
        <where>
            cct.`level`='2'
            and cct.gradeid=#{gradeid}
        </where>
    </select>

    <!--学生已做提高题数量（年级） -->
    <select id="selectLevelCountDone" resultType="int">
        SELECT
        count(1) `count`
        FROM
        ck_course_testpaper cct
        INNER JOIN ck_course_testpaper_student ccts ON cct.paperid=ccts.paperid
        AND cct.isdel = '0'
        AND ccts.`status`='1'
        AND ccts.studentid=#{studentid}
        <where>
            cct.`level` = '2'
            AND cct.gradeid =#{gradeid}
        </where>
    </select>

    <!--教师端根据itemid查询课题列表-->
    <select id="teacherCoureTestpaperListByItemId" resultMap="TeacherCourseTestpaperListVo">
        SELECT
            ct.paperid,
            any_value ( ct.papernum ) papernum,
            any_value ( ct.type ) type,
            any_value ( ct.`status` ) status,
            any_value ( ct.num ) num,
            any_value ( ct.ctime ) ctime,
            any_value ( ct.utime ) utime,
            any_value ( ct.isdel ) isdel,
            any_value ( ct.`level` ) level,
            any_value ( ct.price ) price,
            any_value ( ct.ischarge ) ischarge,
            any_value ( ct.count ) count,
            any_value ( ct.gradeid ) gradeid,
            any_value ( ct.subjectid ) subjectid,
            any_value ( ct.papertitle ) papertitle,
            any_value ( cs.subjectname ) subjectname,
            any_value ( c.coursetitle ) coursetitle,
            any_value ( sg.gradename ) gradename,
            any_value ( ifnull(t.introduce, '')) introduce,
            count( cip.practiceid ) practicenum
        FROM
            ck_course_testpaper ct
            INNER JOIN ck_course_item_testpaper cit ON cit.paperid = ct.paperid
            AND ct.isdel = '0' AND ct.status = '1' AND cit.itemid = #{itemid}
            INNER JOIN ck_course_item ci ON ci.itemid = cit.itemid AND ci.isdel = '0' AND ci.status = '1'
            INNER JOIN ck_course c ON c.courseid = ci.courseid AND c.isdel = '0' AND c.istop = '1'
            INNER join ck_teacher t on t.teacherid = ci.teacherid
            INNER JOIN ck_course_subject cs ON cs.subjectid = c.subjectid AND cs.status = '1'
            INNER JOIN ck_school_grade sg ON sg.gradeid = ci.gradeid
            LEFT JOIN ck_course_item_practice cip ON cip.paperid = ct.paperid
            AND cip.isdel = '0' AND cip.status = '1'
        GROUP BY ct.paperid
    </select>

    <select id="getTestPaperNoPayByStudentGrade" resultMap="BaseResultMap">
        SELECT T.* FROM ck_course_testpaper T LEFT JOIN ck_course_item_testpaper_active P ON T.paperid=P.paperid AND P.`status` != '1' AND T.isdel='0' AND P.studentid=#{studentid}
        LEFT JOIN ck_course_item_testpaper IT ON T.paperid=IT.paperid
        LEFT JOIN ck_course_item I ON IT.itemid=I.itemid AND I.isdel='0' AND I.status = '1'
        LEFT JOIN ck_course C ON C.courseid=I.courseid AND C.isdel='0'
        where T.gradeid=#{gradeid}
    </select>

    <update id="updateTestpaperCountByPaperid">
        UPDATE ck_course_testpaper SET count=count+1 WHERE paperid=#{paperid} and isdel = '0'
    </update>

    
    <select id="selectByItemid" resultMap="BaseResultListMapVo">
       SELECT
            cct.paperid,
            cct.papernum,
            cct.type,
            cct.STATUS,
            IFNULL(ccts.num,'0') num,
            cct.ctime,
            cct.utime,
            cct.isdel,
            cct.LEVEL,
            cct.price,
            cct.ischarge,
            count(1) `count`,
            cct.gradeid,
            cct.subjectid,
            cct.papertitle,
            IFNULL(ccd.id,'') alone,
            IFNULL(a.id, '') alonepack
        FROM
            ck_course_testpaper cct INNER JOIN
            ck_course_item_testpaper ccit ON cct.paperid=ccit.paperid
            AND ccit.itemid=#{itemid} AND cct.isdel = '0' AND cct.`status`='1'
            INNER JOIN ck_course_item_practice ccip ON cct.paperid=ccip.paperid AND ccip.isdel = '0'
            LEFT JOIN ck_course_testpaper_student ccts ON ccts.paperid=cct.paperid
            AND ccts.studentid=#{studentid}
            LEFT JOIN ck_capital_detail ccd ON ccd.paperid=cct.paperid
            AND ccd.studentid=#{studentid} AND ccd.coursepaytype='0'
            LEFT JOIN (
                SELECT
                    cca.acitveid,
                    cta.paperid,
                    cta.activenum,
                    ccd.id,
                    ccd.studentid
                FROM
                    ck_course_item_testpaper_active cta
                INNER JOIN ck_course_active cca ON cta.activenum=cca.activenum AND cta.type = '1'
                LEFT JOIN ck_capital_detail ccd ON ccd.paperid = cca.acitveid
                AND ccd.coursepaytype = '2' AND ccd.studentid =#{studentid}
            ) a ON a.paperid = cct.paperid
            GROUP BY cct.paperid
            ORDER BY cct.ischarge ASC
    </select>
    
    <!--试卷详情查看是否购买记录及试卷价钱 -->
    <select id="selectPaperDetails" resultMap="BaseResultListMapVo">
        SELECT
            IFNULL(a.actuvetitle,'') actuvetitle,
            cct.ischarge,
            IFNULL(cct.price, '') price,
            IFNULL(a.acitveid, '') acitveid,
            IFNULL(a.price, '') priceback,
            IFNULL(a.fold, '') fold,
            IFNULL(ccd.id, '') alone,
            IFNULL(a.id, '') alonepack,
            IFNULL(a.memo, '') memo
        FROM
            ck_course_testpaper cct
        LEFT JOIN ck_capital_detail ccd ON ccd.paperid = cct.paperid
        AND ccd.studentid = #{studentid}
        AND ccd.coursepaytype = '0'
        LEFT JOIN (
            SELECT
                cta.paperid,
                cca.acitveid,
                cca.actuvetitle,
                cca.price,
                cca.fold,
                cca.memo,
                ccd.id,
                ccd.studentid
            FROM
                ck_course_item_testpaper_active cta
            INNER JOIN ck_course_active cca ON cta.activenum=cca.activenum AND cta.type = '1'
            LEFT JOIN ck_capital_detail ccd ON ccd.paperid = cca.acitveid
            AND ccd.coursepaytype = '2' AND ccd.studentid = #{studentid}
        ) a ON a.paperid = cct.paperid
        WHERE
            cct.paperid =#{paperid}
    </select>
    
    <!--已购习题 -->
    <select id="selectExercisesPurchased" resultMap="BaseResultMap">
        SELECT DISTINCT
        cct.paperid,
        cct.papernum,
        cct.type,
        cct. STATUS,
        cct.num,
        cct.ctime,
        cct.utime,
        cct.isdel,
        cct.`level`,
        cct.price,
        cct.ischarge,
        cct.`count`,
        cct.gradeid,
        cct.subjectid,
        cct.papertitle
    FROM
            ck_course_testpaper cct
    LEFT JOIN ck_course_item_testpaper_active ccita ON cct.paperid = ccita.paperid
    LEFT JOIN ck_course_active cca ON cca.activenum = ccita.activenum
    LEFT JOIN (
        SELECT
            paperid,
            coursepaytype
        FROM
            ck_capital_detail
        WHERE
            studentid =#{StudentcourseTestpaperCo.studentid}
        AND coursepaytype IN ('0', '2')
    ) a ON (
        (
            a.coursepaytype = '2'
            AND a.paperid = cca.acitveid
        )
        OR (
            a.coursepaytype = '0'
            AND a.paperid = cct.paperid
        )
    )
    WHERE
        (
            (
                a.coursepaytype = '2'
                AND a.paperid = cca.acitveid
            )
            OR (
                a.coursepaytype = '0'
                AND a.paperid = cct.paperid
            )
        )
    AND cct.isdel='0'
    AND cct.`status`='1'
    </select>

    <!-- 通过视频ids获取试卷集合 -->
    <select id="getTestpaperListByItemIds" resultMap="TeacherCourseCheckTestpaperListVo">
        select
        cct.paperid,
        cct.papernum,
        cct.type,
        cct.status,
        cct.num,
        cct.ctime,
        cct.utime,
        cct.isdel,
        cct.`level`,
        cct.price,
        cct.ischarge,
        cct.`count`,
        cct.gradeid,
        cct.subjectid,
        cct.papertitle,
        cit.itemid
        from
        ck_course_testpaper cct
        inner join ck_course_item_testpaper cit on cit.paperid = cct.paperid
        <if test="ids.size() > 0">
            and cit.itemid in
            <foreach item="id" collection="ids" separator="," open="(" close=")" index="">
                #{id}
            </foreach>
        </if>
        AND cct.isdel = '0' AND cct.`status`='1'
        ORDER BY cct.`level` + 0
    </select>

    <!--查询试卷学生是否被买过 -->
    <select id="selectStudentPaperActive" resultMap="BaseResultListMapVo">
        SELECT
            cct.paperid,
            IFNULL(ccd.id, '') alone,
            IFNULL(a.id, '') alonepack
        FROM
         ck_course_testpaper cct
        LEFT JOIN ck_capital_detail ccd ON ccd.paperid = cct.paperid
        AND ccd.coursepaytype = '0'
        AND ccd.studentid =#{studentid}
        LEFT JOIN (
            SELECT
                cca.acitveid,
                cta.paperid,
                cta.activenum,
                ccd.id,
                ccd.studentid
            FROM
                ck_course_item_testpaper_active cta
            INNER JOIN ck_course_active cca ON cta.activenum = cca.activenum
            AND cta.type = '1'
            LEFT JOIN ck_capital_detail ccd ON ccd.paperid = cca.acitveid
            AND ccd.coursepaytype = '2'
            AND ccd.studentid =#{studentid}
        ) a ON a.paperid = cct.paperid
         <where>
             cct.paperid=#{paperid}
         </where>
    </select>

    <!--试卷正确率计算-->
    <select id="selectStudentAccuracy" resultMap="BaseResultMapVo">
        SELECT
            IFNULL(sum(case cipa.iscorrect when '1' then 1 else 0 end),'0') rightnum,
            IFNULL(sum(case cipa.iscorrect when '0' then 1 else 0 end),'0') failnum
        FROM
            ck_course_item_practice cip
        LEFT JOIN ck_course_item_practice_answer cipa ON cip.practiceid=cipa.practiceid
        WHERE
        cip.paperid=#{paperid}
        AND cipa.studentid=#{studentid}
    </select>
    
    <!--考试试卷列表-->
    <select id="selectTestperExamination" resultMap="Testperexamination">
        SELECT
            ct.paperid,
            ct.papertitle,
            ct.memo,
            ct.fullmark,
            ct.ctime,
            ct.teststarttime,
            ct.examinationendtime,
            cs.subjectname,
            IFNULL(cts.`status`,'-1') `status`,
            IFNULL(cts.fraction,'') fraction,
            IFNULL(cts.num,'') num,
            IFNULL(cts.kscore,'') kscore,
            IFNULL(cts.zscore,'') zscore,
            IFNULL(cts.adscore,'') adscore
        FROM
            `ck_course_testpaper` ct
        LEFT JOIN ck_course_testpaper_student cts ON ct.paperid=cts.paperid
        AND cts.studentid=#{studentid}
        INNER JOIN ck_course_subject cs ON ct.subjectid=cs.subjectid
        WHERE
            ct.`status` = '1'
        AND ct.isdel = '0'
        AND ct.istest = '1'
        AND ct.gradeid = #{gradeid}
        GROUP BY ct.ctime ASC
    </select>

    <!--学习报告答题正确率-->
    <select id="selectGradeAccuracyUnmber" resultMap="BaseResultMapVo">
        SELECT
            cs.subjectname,
            ct.subjectid
        FROM
            ck_course_testpaper ct
        INNER JOIN ck_course_subject cs ON ct.subjectid = cs.subjectid
        AND ct.gradeid =#{gradeid}
        AND ct.isdel='0'
        GROUP BY
            ct.subjectid
    </select>
</mapper>
