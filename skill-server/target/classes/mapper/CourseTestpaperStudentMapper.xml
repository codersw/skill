<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skill.server.mapper.CourseTestpaperStudentMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.skill.server.entity.pojo.CourseTestpaperStudent">
        <id column="id" property="id" />
        <result column="paperid" property="paperid" />
        <result column="studentid" property="studentid" />
        <result column="status" property="status" />
        <result column="num" property="num" />
        <result column="fraction" property="fraction" />
        <result column="ctime" property="ctime" />
        <result column="marknum" property="marknum"/>
        <result column="kscore" property="kscore"/>
        <result column="zscore" property="zscore"/>
        <result column="adscore" property="adscore"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, paperid, studentid, status, num, marknum, kscore, zscore, adscore
    </sql>

    <!--自定义查询-->
    <resultMap id="AnswernumberVo" type="com.skill.server.entity.vo.AnswernumberVo" extends="BaseResultMap">
        <result column="answernumber" property="answernumber"/>
        <result column="increasenumber" property="increasenumber"/>
        <result column="questionsnumber" property="questionsnumber"/>
    </resultMap>

    <select id="selectCourseTestpaperStudent" resultMap="BaseResultMap">
        select
             id,
             paperid,
             studentid,
             status,
             num,
             marknum,
             kscore
        from
            ck_course_testpaper_student
         <where>
             paperid=#{paperid}
             and studentid=#{studentid}
         </where>
    </select>

    <!--查询第几题-->
    <select id="selectCourseTestpaperStudentNum" resultMap="BaseResultMap">
        select
        num,
        status
        from
        ck_course_testpaper_student
        <where>
            paperid=#{paperid}
            and studentid=#{studentid}
        </where>
    </select>

    <!--获取试卷已答题班级以及人数-->
    <select id="selectAnswerClassListByPaperId" resultType="map">
        SELECT
          any_value(sc.classid) as classid,
          any_value(sc.classname) as classname,
          any_value(sg.gradeid) as gradeid,
          any_value(sg.gradename) as gradename,
          count(1) as num,
          ifnull(c.marknum, 0) marknum
        FROM ck_course_testpaper_student cts
        INNER JOIN ck_course_testpaper ct ON ct.paperid = cts.paperid AND ct.isdel = '0' AND cts.status in ('0','1','2','3','4') AND ct.paperid = #{params.paperid}
        INNER JOIN ck_school_studentinfo ss ON ss.studentid = cts.studentid
        INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
        INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
        <if test="params.classid != null and params.classid != ''">
            and ss.studentclass = #{params.classid}
        </if>
        <if test="params.gradeid != null and params.gradeid != ''">
            and ss.grade = #{params.gradeid}
        </if>
        and ss.schoolid = #{params.schoolid}
        left join (
        select
        count(1) as marknum,
        ss.studentclass classid,
        ss.grade gradeid
        from ck_course_testpaper_student cts
        inner join ck_school_studentinfo ss on ss.studentid = cts.studentid AND cts.paperid = #{params.paperid}
        <if test="params.classid != null and params.classid != ''">
            AND ss.studentclass = #{params.classid}
        </if>
        <if test="params.gradeid != null and params.gradeid != ''">
            AND ss.grade = #{params.gradeid}
        </if>
        and cts.status in ('3','4') group by ss.grade,ss.studentclass
        ) c on c.gradeid = sg.gradeid and c.classid = sc.classid
        GROUP BY sg.gradeid,sc.classid
    </select>

    <!--获取试卷所有答题人-->
    <select id="selectAnswerStudentListByPaperId" resultType="map">
       SELECT
            any_value ( cia.answerid ) answerid,
            any_value ( sc.classid ) classid,
            any_value ( sc.classname ) classname,
            any_value ( sg.gradeid ) gradeid,
            any_value ( sg.gradename ) gradename,
            any_value ( ss.studentid ) studentid,
            any_value ( ss.studentname ) studentname,
            any_value ( cts.num ) num,
            ifnull(any_value ( cts.fraction ), "0") fraction,
            ifnull(any_value ( cts.kscore ), "0") kscore,
            ifnull(any_value ( cts.zscore ), "0") zscore,
            ifnull(any_value ( cts.adscore ), "0") adscore,
            ifnull(any_value ( cts.`status` ), "0") `status`,
            ifnull(any_value ( ss.photo ), "") photo,
            any_value ( cts.ctime ) ctime,
            SUM( CASE WHEN cip.type IN (${params.objective}) THEN 1 ELSE 0 END ) objective,
            SUM( CASE WHEN cip.type IN (${params.subjective}) THEN 1 ELSE 0 END ) subjective,
            COUNT(1) answernum
        FROM
            ck_course_item_practice_answer cia
            INNER JOIN ck_school_studentinfo ss ON ss.studentid = cia.studentid
            AND ss.studentclass = #{params.classid}
            AND ss.grade = #{params.gradeid}
            INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
            INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
            INNER JOIN ck_course_item_practice cip ON cip.practiceid = cia.practiceid
            AND cip.paperid = #{params.paperid}
            INNER JOIN ck_course_testpaper_student cts ON cts.studentid = cia.studentid
            AND cts.paperid = cip.paperid AND cts.status in ('0','1','2','3','4')
        GROUP BY
            ss.studentid
    </select>

    <!--查看当前题的提交状态 -->
    <select id="selectPapertidSubmit" resultMap="BaseResultMap">
        select IFNULL((
            SELECT
                 `status`
            FROM
                ck_course_testpaper_student
            WHERE
                paperid =#{paperid}
            AND studentid =#{studentid}),'0') `status`
    </select>

    <select id="statisticsAnswerNum" resultType="map">
        SELECT
            count(1) AS num,
            ct.level,
            DATE_FORMAT(cts.ctime, '%m/%d' ) date
        FROM
            `ck_course_testpaper_student` cts
            INNER JOIN ck_course_testpaper ct ON ct.paperid = cts.paperid
            AND ct.isdel = '0'
            <if test="statisticsCo.startDate != null and statisticsCo.startDate != '' and statisticsCo.endDate != null and statisticsCo.endDate != ''">
                AND DATE(cts.ctime) between #{statisticsCo.startDate} and #{statisticsCo.endDate}
            </if>
            <if test="statisticsCo.gradeid != null and statisticsCo.gradeid != ''">
                AND ct.gradeid  = #{statisticsCo.gradeid}
            </if>
            <if test="statisticsCo.schoolid != null and statisticsCo.schoolid !=''">
                INNER JOIN ck_school_studentinfo ss ON ss.studentid = cts.studentid
                AND ss.schoolid  = #{statisticsCo.schoolid}
            </if>
        GROUP BY
            Date( cts.ctime ),
            ct.LEVEL
        ORDER BY cts.ctime, ct.LEVEL + 0
    </select>

    <select id="statisticsSubjectAnswerNum" resultType="map">
        SELECT
            cs.subjectid,
            cs.subjectname,
            count(1) num,
            ct.level
        FROM
            `ck_course_testpaper_student` cts
            INNER JOIN ck_course_testpaper ct ON ct.paperid = cts.paperid
            AND ct.isdel = '0' AND ct.status = '1'
            <if test="statisticsCo.startDate != null and statisticsCo.startDate != '' and statisticsCo.endDate != null and statisticsCo.endDate != ''">
                AND DATE(cts.ctime) between #{statisticsCo.startDate} and #{statisticsCo.endDate}
            </if>
            <if test="statisticsCo.gradeid != null and statisticsCo.gradeid != ''">
                AND ct.gradeid  = #{statisticsCo.gradeid}
            </if>
            <if test="statisticsCo.schoolid != null and statisticsCo.schoolid !=''">
              INNER JOIN ck_school_studentinfo ss ON ss.studentid = cts.studentid
                AND ss.schoolid  = #{statisticsCo.schoolid}
            </if>
            INNER JOIN ck_course_subject_grade csg ON csg.subjectid = ct.subjectid
            AND csg.gradeid = ct.gradeid
            AND csg.STATUS = '1'
            INNER JOIN ck_course_subject cs ON cs.subjectid = ct.subjectid
            AND cs.STATUS = '1'
        GROUP BY
            ct.subjectid,
            ct.level
        ORDER BY
            cs.num + 0,
            ct.level + 0
    </select>

    <!--答题数数量 -->
    <select id="selectAnswernumber" resultMap="AnswernumberVo">
        SELECT
          count(1) answernumber,
          sum( CASE WHEN ct.`level` = '2' THEN 1 ELSE 0 END ) increasenumber,
          sum( CASE WHEN ct.`level` = '1' THEN 1 ELSE 0 END ) questionsnumber
        FROM
            ck_course_testpaper ct
         INNER JOIN `ck_course_testpaper_student` cts  ON cts.paperid=ct.paperid AND cts.studentid=#{studentid} AND ct.istest='0' AND ct.gradeid=#{gradeid}
    </select>

    <!-- 查询平均答题正确率 -->
    <select id="selectRightPercent" resultType="map">
        SELECT
         cs.subjectid,
         cs.subjectname,
         ct.paperid,
         ct.papertitle,
         sum( CASE WHEN cipa.iscorrect = '1' THEN 1 ELSE 0 END ) rightnum,
         sum( CASE WHEN cipa.iscorrect in ('0', '-1') THEN 1 ELSE 0 END ) failnum,
         count( 1 ) num
        FROM
         ck_course_testpaper_student cts
         INNER JOIN ck_course_testpaper ct ON ct.paperid = cts.paperid
         AND ct.isdel = '0' AND ct.status = '1'
         AND cts.STATUS IN ( '3', '4' )
         <if test="paperids != null and paperids.size > 0">
             and cts.paperid in
             <foreach collection="paperids" open="(" close=")"  item="id" separator="," index="">
                #{id}
             </foreach>
         </if>
         <if test="gradeid != null and gradeid != ''">
             AND ct.gradeid = #{gradeid}
         </if>
        <if test="studentid != null and studentid != ''">
            AND cts.studentid = #{studentid}
        </if>
         INNER JOIN ck_course_item_practice cip ON cip.paperid = ct.paperid
         AND cip.isdel = '0'
         INNER JOIN ck_course_item_practice_answer cipa ON cts.studentid = cipa.studentid
         AND cipa.practiceid = cip.practiceid
         INNER JOIN ck_course_subject cs ON cs.subjectid = ct.subjectid
         AND cs.STATUS = '1'
        GROUP BY
         cs.subjectid,
         cts.paperid
    </select>
</mapper>
