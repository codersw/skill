<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skill.server.mapper.CourseItemMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.skill.server.entity.pojo.CourseItem">
        <id column="itemid" property="itemid" />
        <result column="itemrid" property="itemrid" />
        <result column="itemtitle" property="itemtitle" />
        <result column="videourl" property="videourl" />
        <result column="courseid" property="courseid" />
        <result column="isfixedtime" property="isfixedtime" />
        <result column="fixedtime" property="fixedtime" />
        <result column="content" property="content" />
        <result column="ctime" property="ctime" />
        <result column="utime" property="utime" />
        <result column="isdel" property="isdel" />
        <result column="praise" property="praise" />
        <result column="readnum" property="readnum" />
        <result column="adduserid" property="adduserid" />
        <result column="status" property="status" />
        <result column="isopen" property="isopen" />
        <result column="videoimg" property="videoimg" />
        <result column="videosize" property="videosize" />
        <result column="videoformat" property="videoformat" />
        <result column="videotime" property="videotime" />
        <result column="gradeid" property="gradeid" />
        <result column="subjectid" property="subjectid" />
        <result column="teacherid" property="teacherid" />
        <result column="testpapercount" property="testpapercount" />
        <result column="issale" property="issale" />
        <result column="price" property="price" />
        <result column="examination" property="examination" />
    </resultMap>

    <!--自定义查询结果-->
    <resultMap id="BaseResultMapVo" type="com.skill.server.entity.vo.CourseItemVo" extends="BaseResultMap">
        <result column="teachername" property="teachername"/>
        <result column="introduce" property="introduce"/>
        <result column="viewingtime" property="viewingtime"/>
        <result column="praiseid" property="praiseid"/>
        <result column="studentutime" property="studentutime"/>
        <result column="common" property="common"/>
        <result column="heighten" property="heighten"/>
        <result column="display" property="display"/>
        <result column="orderid" property="orderid"/>
        <result column="studentid" property="studentid"/>
        <association column="{itemid=itemid,studentid=studentid}" property="paperList" select="com.skill.server.mapper.CourseTestpaperMapper.selectByItemid">
        </association>
    </resultMap>

    <!--自定义查询结果-->
    <resultMap id="BaseResultMapSeeVo" type="com.skill.server.entity.vo.CourseItemVo" extends="BaseResultMap">
        <result column="teachername" property="teachername"/>
        <result column="common" property="common"/>
        <result column="heighten" property="heighten"/>
        <result column="introduce" property="introduce"/>
        <result column="subjectname" property="subjectname"/>
        <result column="itemnum" property="itemnum"/>
        <result column="historynum" property="historynum"/>
        <result column="orderid" property="orderid"/>
        <result column="display" property="display"/>
    </resultMap>

    <!--视频详情-->
    <resultMap id="praiseVo" type="com.skill.server.entity.vo.CourseItemVo" extends="BaseResultMap">
        <result column="praiseid" property="praiseid"/>
        <result column="orderid" property="orderid"/>
    </resultMap>


    <!--教师端列表查询结果-->
    <resultMap id="TeacherCourseItemListVo" type="com.skill.server.entity.vo.TeacherCourseItemListVo" extends="BaseResultMap">
        <result column="subjectname" property="subjectname"/>
        <result column="coursetitle" property="coursetitle"/>
        <result column="teachername" property="teachername" />
        <result column="gradename" property="gradename"/>
        <result column="common" property="common"/>
        <result column="heighten" property="heighten"/>
    </resultMap>

    <!--教师端详情查询结果-->
    <resultMap id="TeacherCourseItemVo" type="com.skill.server.entity.vo.TeacherCourseItemVo" extends="BaseResultMap">
        <result column="teachername" property="teachername"/>
        <result column="introduce" property="introduce"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        itemid, itemrid, itemtitle, videourl, courseid, isfixedtime, fixedtime, content, ctime, utime, isdel, praise, readnum, adduserid, status, isopen, videoimg, videosize, videoformat, videotime, gradeid, subjectid, teacherid
    </sql>

    <!--获取实体-->
    <select id="selectByItemId" resultMap="BaseResultMapSeeVo">
        SELECT
    <!--   ci.itemid,
       ci.itemrid,
       ci.itemtitle,
       ci.videourl,
       ci.courseid,
       ci.isfixedtime,
       ci.fixedtime,
       ci.content,
       ci.ctime,
       ci.utime,
       ci.isdel,
       ci.praise,
       ci.readnum,
       ci.adduserid,
       ci.`status`,
       ci.isopen,
       ci.videoimg,
       ci.videosize,
       ci.videoformat,
       ci.videotime,
       ci.gradeid,
       ci.subjectid,
       ci.teacherid,
       ct.teachername,-->
       ci.content,
       ct.introduce
     FROM
     ck_course_item ci
     INNER JOIN ck_teacher ct ON ct.teacherid = ci.teacherid AND ci.itemid = #{itemid} AND ci.isdel='0' AND ci.`status`='1'
     LEFT JOIN ck_course_praiseid ccp ON ci.courseid=ccp.courseid  AND ccp.studentid=#{student}
    </select>

    <!--视频详情（地址、封面）固定时间 -->
    <select id="selectItemUrl" resultMap="praiseVo">
        SELECT
            ci.videourl,
            ci.videoimg,
            ci.praise,
            ci.readnum,
            IFNULL(cp.praiseid,'') praiseid
        FROM
            ck_course_item ci
        LEFT JOIN ck_course_praiseid cp ON ci.itemid=cp.itemid
        AND cp.studentid=#{studentid}
        WHERE
            ci.itemid = #{itemid}
        AND DATE(ci.fixedtime) &lt;=DATE(NOW())
        LIMIT 1
    </select>

    <!--视频详情（地址、封面）不固定时间 -->
    <select id="noSelectItemUrl" resultMap="praiseVo">
        SELECT
            ci.videourl,
            ci.videoimg,
            ci.praise,
            ci.readnum,
            IFNULL(cp.praiseid,'') praiseid
        FROM
            ck_course_item ci
        LEFT JOIN ck_course_praiseid cp ON ci.itemid=cp.itemid
        AND cp.studentid=#{studentid}
        WHERE
            ci.itemid = #{itemid}
        LIMIT 1
    </select>

 <!--教师端获取视频详情-->
    <select id="selectTeacherCourseByItemId" resultMap="TeacherCourseItemVo">
        SELECT
          ci.itemid,
          ci.itemrid,
          ci.itemtitle,
          ci.videourl,
          ci.courseid,
          ci.isfixedtime,
          ci.fixedtime,
          ci.content,
          ci.ctime,
          ci.utime,
          ci.isdel,
          ci.praise,
          ci.readnum,
          ci.adduserid,
          ci.`status`,
          ci.isopen,
          ci.videoimg,
          ci.videosize,
          ci.videoformat,
          ci.videotime,
          ci.gradeid,
          ci.subjectid,
          ci.teacherid,
          ct.teachername,
          ifnull(ct.introduce, '') introduce
        FROM
        ck_course_item ci
        INNER JOIN ck_teacher ct ON ct.teacherid = ci.teacherid AND ci.itemid = #{itemid} AND ci.isdel='0' AND ci.`status`='1'
    </select>

    <!--获取点赞数-->
    <select id="studentCourseItmePraisecount" resultType="int">
    SELECT praise from ck_course_item
    <where>
        itemid=#{itemid}
    </where>
    </select>

    <!--获取点观看次数-->
    <select id="studentCourseItmeReadnumcount" resultType="int">
        SELECT readnum from ck_course_item
        <where>
            itemid=#{itemid}
        </where>
    </select>

    <!--获取列表-->
    <select id="studentCourseItmelist" resultMap="BaseResultMapVo">
        SELECT
          ci.itemid,
          any_value(ci.itemrid) itemrid,
          any_value(ci.itemtitle) itemtitle,
          any_value(ci.courseid) courseid,
          any_value(ci.isfixedtime) isfixedtime,
          any_value(ci.fixedtime) fixedtime,
          any_value(ci.content) content,
          any_value(ci.ctime) ctime,
          any_value(ci.utime) utime,
          any_value(ci.isdel) isdel,
          any_value(ci.praise) praise,
          any_value(ci.readnum) readnum,
          any_value(ci.adduserid) adduserid,
          any_value(ci.`status`) status,
          any_value(ci.isopen) isopen,
          any_value(ci.videoimg) videoimg,
          any_value(ci.videosize) videosize,
          any_value(ci.videoformat) videoformat,
          any_value(ci.videotime) videotime,
          any_value(ci.gradeid) gradeid,
          any_value(ci.subjectid) subjectid,
          any_value(ci.teacherid) teacherid,
          any_value(ci.issale) issale,
          any_value(ci.price) price,
          any_value(ct.teachername) teachername,
          any_value(cih.viewingtime) viewingtime,
          any_value(ccf.ctime) cctime,
          any_value(ccp.praiseid) praiseid,
          any_value(IFNULL(ccd.id,'')) orderid,
          case when any_value(DATE(ci.fixedtime))>DATE(NOW()) then '0' else '1' end display,
          #{CouresItemCo.studentid} studentid
        FROM
        ck_course_item ci
        INNER JOIN ck_teacher ct ON ct.teacherid = ci.teacherid AND ci.isdel='0' AND ci.`status`='1' AND ci.examination='0'
        <if test="CouresItemCo.courseid != null and CouresItemCo.courseid !=''">
            AND ci.courseid =#{CouresItemCo.courseid}
        </if>
        <if test="CouresItemCo.itemid != null and CouresItemCo.itemid !=''">
            AND  ci.itemid =#{CouresItemCo.itemid}
        </if>
        LEFT JOIN ck_course_item_history cih ON ci.itemid = cih.itemid AND ci.courseid = cih.courseid  AND cih.studentid=#{CouresItemCo.studentid}
        LEFT JOIN ck_course_favorites ccf ON ci.itemid = ccf.itemid AND ci.courseid = ccf.courseid
        AND ccf.studentid=#{CouresItemCo.studentid}
        LEFT JOIN ck_capital_detail ccd ON ccd.paperid=ci.itemid
        AND ccd.coursepaytype='1' AND ccd.studentid=#{CouresItemCo.studentid}
        LEFT JOIN ck_course_praiseid ccp ON ci.itemid=ccp.itemid  AND ccp.studentid=#{CouresItemCo.studentid}
        GROUP BY ci.itemid
        ORDER BY ci.fixedtime,ci.itemrid + 0,ci.ctime
    </select>
    <!--学生观看过的视频-->
    <select id="selectStudentAlreadySeen" resultMap="BaseResultMapSeeVo">
        SELECT
            cci.itemid,
            cci.itemtitle,
            cci.videotime,
            cci.utime,
            cci.teacherid,
            cci.issale,
            cci.price,
            ct.teachername,
            cci.fixedtime,
            case when any_value(DATE(cci.fixedtime))>DATE(NOW()) then '0' else '1' end display,
            IFNULL(ccd.id,'') orderid
        FROM
            ck_course_item cci
            INNER JOIN ck_teacher ct ON cci.teacherid=ct.teacherid AND cci.isdel='0' AND cci.`status`='1'
            INNER JOIN ck_course_subject cs on cs.subjectid=cci.subjectid
            INNER JOIN ck_course cc ON cc.courseid=cci.courseid
            INNER JOIN ck_course_school ccs ON ccs.courseid=cc.courseid
            AND ccs.schoolid=#{courseItemListCo.schoolid}
            LEFT JOIN ck_capital_detail ccd ON ccd.paperid=cci.itemid
            AND ccd.coursepaytype='1' AND ccd.studentid=#{courseItemListCo.studentid}
        <where>
            cci.gradeid=#{courseItemListCo.gradeid}
            <if test="courseItemListCo.papertitle != null and courseItemListCo.papertitle !=''">
                and cci.itemtitle LIKE CONCAT('%',#{courseItemListCo.papertitle},'%')
            </if>
            <if test="courseItemListCo.subjectid != null and courseItemListCo.subjectid !=''">
                and cci.subjectid = #{courseItemListCo.subjectid}
            </if>
            <if test="courseItemListCo.utime != null and courseItemListCo.utime !=''">
                AND DATE_FORMAT(cci.fixedtime, "%Y-%m") =#{courseItemListCo.utime}
            </if>
        </where>
        order by cci.fixedtime ASC,cs.num+0
    </select>
    <!--教师端获取教师视频列表-->
    <select id="teacherCourseItemList" resultMap="TeacherCourseItemListVo">
        SELECT
          any_value(cs.subjectname) subjectname,
          any_value(c.coursetitle) coursetitle,
          any_value(ci.itemid) itemid,
          any_value(ci.itemrid) itemrid,
          any_value(ci.itemtitle) itemtitle,
          any_value(ci.videourl) videourl,
          any_value(ci.courseid) courseid,
          any_value(ci.isfixedtime) isfixedtime,
          any_value(ci.fixedtime) fixedtime,
          any_value(ci.content) content,
          any_value(ci.ctime) ctime,
          any_value(ci.utime) utime,
          any_value(ci.isdel) isdel,
          any_value(ci.praise) praise,
          any_value(ci.readnum) readnum,
          any_value(ci.adduserid) adduserid,
          any_value(ci.`status`) status,
          any_value(ci.isopen) isopen,
          any_value(ci.videoimg) videoimg,
          any_value(ci.videosize) videosize,
          any_value(ci.videoformat) videoformat,
          any_value(ci.videotime) videotime,
          any_value(ci.gradeid) gradeid,
          any_value(ci.subjectid) subjectid,
          any_value(ci.teacherid) teacherid,
          any_value(tt.teachername) teachername,
          any_value(sg.gradename) gradename,
          sum(case ct.`level` when '1' then 1 else 0 end) common,
          sum(case ct.`level` when '2' then 1 else 0 end) heighten
        FROM
        ck_course_item ci
        inner join ck_course c ON ci.courseid = c.courseid and c.isdel = '0' and ci.isdel = '0' AND ci.`status` = '1' AND c.istop = '1'
        inner join ck_course_subject cs on cs.subjectid = c.subjectid and cs.status = '1'
        inner join ck_course_item_testpaper cit on cit.courseid = c.courseid and cit.itemid = ci.itemid
        inner join ck_course_testpaper ct on ct.paperid = cit.paperid and ct.isdel = '0' and ct.status = '1'
        inner join ck_teacher tt on tt.teacherid = ci.teacherid
        inner join ck_school_grade sg on sg.gradeid = ci.gradeid
        INNER JOIN ck_course_school ccs ON ccs.courseid = c.courseid AND ccs.schoolid = #{courseListCo.schoolid}
        INNER JOIN (select gradeid from ck_school_class where schoolid = #{courseListCo.schoolid} group by gradeid) d on d.gradeid = ci.gradeid
        <if test="courseListCo.teacherid != null and courseListCo.teacherid != ''">
            inner join (select teacherid,gradeid,schoolid from ck_teach WHERE teacherid = #{courseListCo.teacherid} group by teacherid,gradeid ) b
            on b.gradeid = ci.gradeid
            <if test="courseListCo.type != '1' and courseListCo.type != 1">
                INNER JOIN ck_teacher_subject ts ON ts.teacherid = b.teacherid
                AND ts.subjectid = ci.subjectid
            </if>
        </if>
        <where>
            1=1
            <if test="courseListCo.keyword != null and courseListCo.keyword !=''">
                and ci.itemtitle LIKE CONCAT('%',#{courseListCo.keyword},'%')
            </if>
            <if test="courseListCo.gradeid != null and courseListCo.gradeid !=''">
                and ci.gradeid = #{courseListCo.gradeid}
            </if>
            <if test="courseListCo.subjectid != null and courseListCo.subjectid !=''">
                and c.subjectid = #{courseListCo.subjectid}
            </if>
            <if test="courseListCo.startDate != null and courseListCo.startDate != '' and courseListCo.endDate != null and courseListCo.endDate != ''">
                and DATE(ci.fixedtime) between #{courseListCo.startDate} and #{courseListCo.endDate}
            </if>
        </where>
        GROUP BY ci.itemid
        ORDER BY ci.fixedtime,ci.itemrid + 0,ci.ctime
    </select>

    <!--教师端获取视频可查看的所有班级以及人数-->
    <select id="selectClassListByItemId" resultType="map" parameterType="map">
        SELECT
            sc.classid,
            sc.classname,
            sg.gradeid,
            sg.gradename,
            ci.itemtitle,
            ci.itemid,
            ci.testpapercount,
            a.num
        FROM
        ck_school_class sc
        INNER JOIN ck_school_grade sg ON sg.gradeid = sc.gradeid AND sc.schoolid = #{params.schoolid}
        <if test="params.classid != null and params.classid != ''">
            AND sc.classid = #{params.classid}
        </if>
        <if test="params.gradeid != null and params.gradeid != ''">
            AND sg.gradeid = #{params.gradeid}
        </if>
        INNER JOIN ck_course_item ci ON ci.gradeid = sc.gradeid  AND ci.itemid = #{params.itemid} AND ci.isdel = '0' AND ci.status = '1'
        <if test="params.teacherid != null and params.teacherid !=''">
            inner join (select teacherid,gradeid,schoolid,classid from ck_teach WHERE teacherid = #{params.teacherid} group by teacherid,gradeid,classid) b
            on b.gradeid = ci.gradeid and b.schoolid = sc.schoolid and b.classid = sc.classid
            INNER JOIN ck_teacher_subject ts ON ts.teacherid = b.teacherid
            AND ts.subjectid = ci.subjectid
        </if>
        INNER JOIN (
        SELECT
            count(1) AS num,
            sg.gradeid,
            sc.classid,
            ss.schoolid,
            sc.classmemo
        FROM
        ck_school_studentinfo ss
        INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
        <if test="params.classid != null and params.classid != ''">
            AND ss.studentclass = #{classid}
        </if>
        <if test="params.gradeid != null and params.gradeid != ''">
            AND ss.grade = #{params.gradeid}
        </if>
        AND ss.schoolid = #{params.schoolid}
        INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
        GROUP BY  sg.gradeid, sc.classid ) a ON a.gradeid = sg.gradeid AND a.classid = sc.classid
        ORDER BY a.classmemo + 0
    </select>

    <!--教师端获取试题可答题的所有班级以及人数-->
    <select id="selectClassListByPaperId" resultType="map" parameterType="map">
        SELECT
            any_value(sc.classid) classid,
            any_value(sc.classname) classname,
            any_value(sg.gradeid) gradeid,
            any_value(sg.gradename) gradename,
            any_value(ci.itemtitle) itemtitle,
            any_value(ci.itemid) itemid,
            any_value(ci.testpapercount) testpapercount,
            any_value(ct.paperid) paperid,
            any_value(ct.papernum) papernum,
            any_value(ct.papertitle) papertitle,
            any_value(a.num) num,
            ifnull(any_value(c.marknum), '0') marknum
        FROM ck_school_class sc
        INNER JOIN ck_school_grade sg ON sg.gradeid = sc.gradeid AND sc.schoolid = #{params.schoolid}
        <if test="params.classid != null and params.classid != ''">
            AND sc.classid = #{params.classid}
        </if>
        <if test="params.gradeid != null and params.gradeid != ''">
            AND sg.gradeid = #{params.gradeid}
        </if>
        INNER JOIN ck_course_item ci ON ci.gradeid = sc.gradeid and ci.isdel = '0' and ci.status = '1'
        INNER JOIN ck_course_item_testpaper cit ON cit.itemid = ci.itemid and cit.paperid = #{params.paperid}
        INNER JOIN ck_course_testpaper ct ON ct.paperid = cit.paperid and ct.isdel = '0' and ct.status = '1'
        INNER JOIN ck_course_item_practice cip ON cip.paperid = ct.paperid and cip.isdel = '0' and cip.status = '1'
        LEFT JOIN ck_course_testpaper_student cts ON cts.paperid = ct.paperid and cts.status in ('3','4')
        <if test="params.teacherid != null and params.teacherid != ''">
            inner join (select teacherid,gradeid,schoolid,classid from ck_teach WHERE teacherid = #{params.teacherid} group by teacherid,gradeid,classid ) b
            on b.gradeid = ci.gradeid and b.schoolid = sc.schoolid and b.classid = sc.classid
            INNER JOIN ck_teacher_subject ts ON ts.teacherid = b.teacherid
            AND ts.subjectid = ci.subjectid
        </if>
        INNER JOIN
        (SELECT
            count(1) AS num,
            sg.gradeid,
            sc.classid,
            ss.schoolid,
            sc.classmemo
        FROM
        ck_school_studentinfo ss
        INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
        <if test="params.classid != null and params.classid != ''">
            AND ss.studentclass = #{params.classid}
        </if>
        <if test="params.gradeid != null and params.gradeid != ''">
            AND ss.grade = #{params.gradeid}
        </if>
        AND ss.schoolid = #{params.schoolid}
        INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
        GROUP BY sg.gradeid,sc.classid) a  ON a.gradeid = sg.gradeid and a.classid = sc.classid
        left join
        (select
          count(1) as marknum,
          ss.studentclass classid,
          ss.grade gradeid
         from ck_course_testpaper_student cts
        inner join ck_school_studentinfo ss on ss.studentid = cts.studentid AND cts.paperid = #{params.paperid}
        <if test="params.classid != null and params.classid != ''">
            AND ss.studentclass = #{params.classid}
        </if>
        <if test="params.gradeid != null and params.gradeid != ''">
            AND ss.grade = #{params.gradeid}
        </if>
        and cts.status in ('3','4') group by ss.grade,ss.studentclass) c on c.gradeid = sg.gradeid and c.classid = sc.classid
        GROUP BY sg.gradeid,sc.classid,ct.paperid
        ORDER BY a.classmemo + 0
    </select>

    <!--指定学校科目中的视频数 -->
    <select id="subjectCourseItemSchoolCount" resultType="int">
        SELECT
        count(*)
        FROM
        ck_course_item cci
        INNER JOIN ck_course cc ON cc.courseid = cci.courseid
        INNER JOIN ck_course_school ccs ON cci.courseid = ccs.courseid
        AND ccs.schoolid = #{schoolid} AND cci.isdel = '0'
        AND cci.subjectid = #{subjectid}
        AND cci.gradeid = #{gradeid}
    </select>
    <!--科目中学生已看的视频数 -->
    <select id="StudentsubjectCourseItemCount" resultType="int">
        SELECT
        count(*)
        FROM
        ck_course_item cci
        INNER JOIN ck_course_item_history ccih ON cci.itemid=ccih.itemid
        AND ccih.studentid=#{studentid}
        INNER JOIN ck_course cc ON cc.courseid=cci.courseid
        INNER JOIN ck_course_school ccs ON ccs.courseid=cc.courseid
        AND ccs.schoolid=#{schoolid}
        <where>
            cci.subjectid =#{subjectid}
            AND cci.gradeid =#{gradeid}
            AND cci.isdel = '0'
        </where>
    </select>

    <!-- 视频中的试卷类型（提高，普通）-->
    <select id="selectTestpaperLevel" resultType="map">
        SELECT
		    IFNULL(sum(case cct.`level` when '1' then 1 else 0 end),'0') common,
            IFNULL(sum(case cct.`level` when '2' then 1 else 0 end),'0') heighten,
            ccit.itemid
        FROM
            ck_course_item_testpaper ccit
        INNER JOIN ck_course_testpaper cct ON ccit.paperid = cct.paperid
        <if test="ids.size() > 0">
            AND ccit.itemid in
            <foreach item="id" collection="ids" separator="," open="(" close=")" index="">
                #{id}
            </foreach>
        </if>
    </select>

    <!--视频总数量（年级） -->
    <select id="selecTitemCount" resultType="int">
        SELECT
            count(1)
        FROM
            ck_course_item cci
        INNER JOIN ck_course cc ON cc.courseid = cci.courseid
        INNER JOIN ck_course_school ccs ON ccs.courseid=cc.courseid
        AND ccs.schoolid=#{schoolid}
        <where>
            cci.gradeid=#{gradeid}
            and cci.isdel='0'
        </where>
    </select>

    <!--当日视频数量（年级） -->
    <select id="selecDataTitemCount" resultType="int">
        SELECT
        count(1)
        FROM
        ck_course_item cci
        INNER JOIN ck_course cc ON cc.courseid = cci.courseid
        INNER JOIN ck_course_school ccs ON ccs.courseid=cc.courseid
        AND ccs.schoolid=#{schoolid}
        <where>
            cci.gradeid=#{gradeid}
            and cci.isdel='0'
        AND date(cci.fixedtime) &lt;= date(NOW())
        </where>
    </select>

    <!--学生已看视频数量（年级） -->
    <select id="selectTitemCountDone" resultType="int">
        SELECT
        count(1)
        FROM
        `ck_course_item_history` ccih
        INNER JOIN ck_course_item cci ON ccih.itemid=cci.itemid
        AND cci.gradeid=#{gradeid}
        and cci.isdel='0'
        INNER JOIN ck_course cc ON cc.courseid=cci.courseid
        INNER JOIN ck_course_school ccs ON ccs.courseid=cc.courseid
        AND ccs.schoolid=#{schoolid}
        <where>
            ccih.studentid =#{studentid}
        </where>
    </select>

    <!--首页科目视频数显示 -->
    <select id="selectHomesubcount" resultMap="BaseResultMapSeeVo">
        SELECT
            cc.courseid,
            cc.subjectid,
            ccs.subjectname,
            count(1) itemnum,
            ifnull(a.historynum, '0') historynum
        FROM
            ck_course cc
        INNER JOIN ck_course_subject ccs ON cc.subjectid=ccs.subjectid and ccs.`status` = '1' and cc.`isdel` = '0' and cc.gradeid =#{gradeid}
        INNER JOIN ck_course_item ci on ci.courseid = cc.courseid and ci.subjectid=ccs.subjectid and ci.`isdel` = '0'
        INNER JOIN ck_course_school cs ON cs.courseid=cc.courseid and cs.schoolid=#{schoolid}
        LEFT JOIN (
            select count(1) historynum,courseid from ck_course_item_history where studentid=#{studentid} GROUP BY courseid
        ) a on a.courseid = cc.courseid
        GROUP BY cc.courseid
    </select>

    <!--已购课程 -->
    <select id="SelectPurchasedCourses" resultMap="BaseResultMapSeeVo">
        SELECT
            cci.itemid,
            cci.itemrid,
            cci.itemtitle,
            cci.videourl,
            cci.courseid,
            cci.isfixedtime,
            cci.fixedtime,
            cci.content,
            cci.ctime,
            cci.utime,
            cci.isdel,
            cci.praise,
            cci.readnum,
            cci.adduserid,
            cci.STATUS,
            cci.isopen,
            cci.videoimg,
            cci.videosize,
            cci.videoformat,
            cci.videotime,
            cci.gradeid,
            cci.subjectid,
            cci.teacherid,
            cci.testpapercount,
            cci.issale,
            cci.price,
            ct.teachername
        FROM
        ck_course_item cci
        INNER JOIN ck_capital_detail ccd ON cci.itemid=ccd.paperid
        AND ccd.studentid=#{courseItemListCo.studentid}
        AND ccd.coursepaytype='1'
        AND cci.isdel='0'
        and cci.`status`='1'
        INNER JOIN ck_teacher ct ON cci.teacherid=ct.teacherid
    </select>
    
    <!--学生是否购买视频记录-->
    <select id="selectStudentItemPurchase" resultMap="praiseVo">
        SELECT
            ci.itemid,
            IFNULL(ccd.id, '') orderid
        FROM
            ck_course_item ci
        LEFT JOIN ck_capital_detail ccd ON ci.itemid = ccd.paperid
        AND ccd.coursepaytype = '1'
        AND ccd.studentid =#{studentid}
        WHERE
            ci.itemid =#{itemid}
    </select>

    <!--年级下科目所有视频数量集合-->
    <select id="selectGradeUnmber" resultMap="BaseResultMapSeeVo">
        SELECT
            count(1) itemnum,
            ci.subjectid,
            cs.subjectname
        FROM
            ck_course_item ci
        INNER JOIN ck_course_subject cs ON ci.subjectid = cs.subjectid
        AND ci.gradeid = #{gradeid}
        AND ci.isdel = '0'
        GROUP BY
            ci.subjectid
        ORDER BY
            ci.subjectid + 0 ASC
    </select>

    <!--学生所看的年级下科目所有视频数量-->
    <select id="selectStudentGradeUnmber" resultMap="BaseResultMapSeeVo">
        SELECT
            COUNT(1) itemnum
        FROM
            ck_course_item_history cih
        INNER JOIN ck_course_item ci ON ci.itemid = cih.itemid
        AND ci.gradeid = #{gradeid}
        AND ci.subjectid = #{subjectid}
        AND cih.studentid = #{studentid}
    </select>
</mapper>
