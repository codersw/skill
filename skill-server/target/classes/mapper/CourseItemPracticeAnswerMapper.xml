<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skill.server.mapper.CourseItemPracticeAnswerMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.skill.server.entity.pojo.CourseItemPracticeAnswer">
        <id column="answerid" property="answerid" />
        <result column="practiceid" property="practiceid" />
        <result column="answer" property="answer" />
        <result column="iscorrect" property="iscorrect" />
        <result column="memo" property="memo" />
        <result column="score" property="score" />
        <result column="readstatus" property="readstatus" />
        <result column="ctime" property="ctime" />
        <result column="utime" property="utime" />
        <result column="studentid" property="studentid" />
    </resultMap>


    <resultMap id="AnswerVo" type="com.skill.server.entity.vo.AnswerVo" extends="BaseResultMap">
        <result column="count" property="count" />
        <result column="correct" property="correct" />
        <result column="error" property="error" />
    </resultMap>
    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        answerid, practiceid, answer, iscorrect, memo, score, readstatus, ctime, utime, studentid
    </sql>

    <select id="selectOptionsidCount" resultMap="AnswerVo">
        SELECT
            answerid,
            practiceid,
            answer,
            iscorrect,
            memo,
            score,
            readstatus,
            ctime,
            utime,
            studentid
        FROM
        `ck_course_item_practice_answer`
        <where>
            practiceid=#{practiceid}
            and studentid=#{studentid}
        </where>
    </select>

    <select id="selectAnswerIsCount" resultType="double">
        SELECT
            count(1) `count`
        FROM
            ck_course_item_practice ccip
        INNER JOIN ck_course_item_practice_answer ccipa ON ccip.practiceid=ccipa.practiceid
        AND ccipa.studentid=#{studentid}
        AND ccip.paperid=#{paperid}
        AND ccipa.iscorrect=#{iscorrect}
    </select>

    <!--计算学生得分-->
    <select id="studentScoreAll" resultType="int">
        SELECT
            IFNULL(SUM(cipa.score),'0')
        FROM
            `ck_course_item_practice_answer` cipa
        INNER JOIN (
            SELECT
                practiceid
            FROM
                ck_course_item_practice
            WHERE
                paperid =#{papreid}
        ) a ON cipa.practiceid = a.practiceid
        WHERE
            studentid = #{studentid}
    </select>
    
    <!--答题总正确数和错误数-->
    <select id="selectAccuracy" resultMap="AnswerVo">
        SELECT
            sum( CASE WHEN iscorrect = '1' THEN 1 ELSE 0 END ) correct,
            sum( CASE WHEN iscorrect = '0' THEN 1 ELSE 0 END ) error
        FROM
            `ck_course_item_practice_answer`
        WHERE
           studentid=#{studentid}
    </select>

    <!--客观题正确率 -->
    <select id="selectObjectiveAccuracy" resultMap="AnswerVo">
        SELECT
            sum(case  pa.iscorrect when '1' then 1 else 0 end) correct,
            sum(case  pa.iscorrect when '0' then 1 else 0 end) error
        FROM
            ck_course_item_practice cip
        INNER JOIN ck_course_testpaper ct ON cip.paperid = ct.paperid
        AND ct.subjectid=#{subjectid}
        AND ct.gradeid=#{gradeid}
        AND ct.isdel='0'
        AND cip.type!='5'
        INNER JOIN ck_course_testpaper_student  ts ON ts.paperid=cip.paperid
        AND ts.`status` in("3","4")
        AND ts.studentid=#{studentid}
        INNER JOIN ck_course_item_practice_answer pa ON pa.practiceid=cip.practiceid
        AND pa.studentid=#{studentid}
    </select>

    <!--主观题正确率 -->
    <select id="selectSubjectiveAccuracy" resultMap="AnswerVo">
        SELECT
            sum(case  pa.iscorrect when '1' then 1 else 0 end) correct,
            sum(case  pa.iscorrect when '0' then 1 else 0 end) error
        FROM
            ck_course_item_practice cip
        INNER JOIN ck_course_testpaper ct ON cip.paperid = ct.paperid
        AND ct.subjectid=#{subjectid}
        AND ct.gradeid=#{gradeid}
        AND ct.isdel='0'
        AND cip.type='5'
        INNER JOIN ck_course_testpaper_student  ts ON ts.paperid=cip.paperid
        AND ts.`status` in("3","4")
        AND ts.studentid=#{studentid}
        INNER JOIN ck_course_item_practice_answer pa ON pa.practiceid=cip.practiceid
        AND pa.studentid=#{studentid}
    </select>
</mapper>
