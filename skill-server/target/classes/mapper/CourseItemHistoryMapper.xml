<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skill.server.mapper.CourseItemHistoryMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.skill.server.entity.pojo.CourseItemHistory">
        <id column="historyid" property="historyid" />
        <result column="studentid" property="studentid" />
        <result column="parentid" property="parentid" />
        <result column="courseid" property="courseid" />
        <result column="viewingtime" property="viewingtime" />
        <result column="itemid" property="itemid" />
        <result column="ctime" property="ctime" />
        <result column="utime" property="utime" />
    </resultMap>

    <resultMap id="BaseResultMapVo" type="com.skill.server.entity.vo.CourseItemHistoryVo">
        <result column="hour" property="hour" />
        <result column="number" property="number" />
        <result column="date" property="date" />
        <result column="hour6_9" property="hour6_9" />
        <result column="hour9_12" property="hour9_12" />
        <result column="hour12_15" property="hour12_15" />
        <result column="hour15_18" property="hour15_18" />
        <result column="hour18_21" property="hour18_21" />
        <result column="hour21_24" property="hour21_24" />
    </resultMap>

    <resultMap id="NumberItemVo" type="com.skill.server.entity.vo.NumberItemVo">
        <result column="numberall" property="numberall" />
        <result column="studentnumber" property="studentnumber" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        historyid, studentid, parentid, courseid, viewingtime, itemid, ctime, utime
    </sql>

    <select id="selecthistoryCount" resultMap="BaseResultMap">
        SELECT
          <include refid="Base_Column_List"/>
        FROM `ck_course_item_history`
        where
            studentid=#{CourseItemHistory.studentid}

            and courseid=#{CourseItemHistory.courseid}
            and itemid=#{CourseItemHistory.itemid}

    </select>

    <!--获取以观看视频班级人数-->
    <select id="selectHistoryClassListByItemId" resultType="map" parameterType="map">
        SELECT
            sc.classid,
            sc.classname,
            sg.gradeid,
            sg.gradename,
            ci.itemid,
            ci.itemtitle,
            count(1) num
        FROM
            ck_course_item_history cih
            INNER JOIN ck_course_item ci ON ci.itemid = cih.itemid AND cih.itemid = #{params.itemid} AND ci.isdel = '0' AND ci.status = '1'
            INNER JOIN ck_school_studentinfo ss ON ss.studentid = cih.studentid
            <if test="params.classid != null and params.classid != ''">
                and ss.studentclass = #{params.classid}
            </if>
            <if test="params.gradeid != null and params.gradeid != ''">
                and ss.grade = #{params.gradeid}
            </if>
            and ss.schoolid = #{params.schoolid}
            INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
            INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
        GROUP BY sg.gradeid, sc.classid
    </select>

    <!--获取以观看视频学生列表-->
    <select id="selectHistoryStudentListByItemId" resultType="map">
        SELECT
          any_value(sc.classid) classid,
          any_value(sc.classname) classname,
          any_value(sg.gradeid) gradeid,
          any_value(sg.gradename) gradename,
          any_value(ss.studentid) studentid,
          any_value(ss.studentname) studentname,
          any_value(ss.photo) photo,
          max(cih.ctime) ctime
        FROM
        ck_course_item_history cih
        INNER JOIN ck_school_studentinfo ss ON ss.studentid = cih.studentid
        AND cih.itemid=#{itemid}
        AND ss.studentclass = #{classid}
        AND ss.grade = #{gradeid}
        INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
        INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
        GROUP BY cih.studentid,cih.itemid
    </select>

    <!--查询班级所有学生-->
    <select id="selectStudentListByClassId" resultType="map">
       SELECT
          sc.classid,
          sc.classname,
          sg.gradeid,
          sg.gradename,
          ss.studentid,
          ss.studentname,
          ss.photo
       FROM ck_school_studentinfo ss
       INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
       INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
       WHERE studentclass = #{classid} AND grade = #{gradeid}
    </select>

    <!-- 查询时间段视频观看人数-->
    <select id="getCkCourseItemHistoryHourNumber" resultMap="BaseResultMapVo">
        select CONCAT(t.groupid,':00~',t.groupid+2,':59') hour,count(t.historyid) as number from (
            SELECT h.historyid,h.ctime,FLOOR((DATE_FORMAT(h.ctime,'%H')*60)/180)*3 as groupid FROM ck_course_item_history h
            INNER JOIN ck_course_item i ON h.itemid=i.itemid WHERE DATE_FORMAT(h.ctime,'%H')>=6
        <if test="gradeid != null and gradeid != ''">
            AND i.gradeid = #{gradeid}
        </if>
        <if test="subjectid != null and subjectid != ''">
            AND i.subjectid = #{subjectid}
        </if>
        <if test="starttime != null and starttime != ''">
            AND DATE_FORMAT(h.ctime,'%Y-%m-%d')>=DATE_FORMAT(#{starttime},'%Y-%m-%d')
        </if>
        <if test="endtime != null and endtime != ''">
            AND DATE_FORMAT(#{endtime},'%Y-%m-%d')>=DATE_FORMAT(h.ctime,'%Y-%m-%d')
        </if>
        ) t group by t.groupid
        order by t.groupid
    </select>

    <!-- 查询时间段视频观看人数-->
    <select id="getCkCourseItemHistoryDateHourNumber" resultMap="BaseResultMapVo">
        SELECT a.date,
        MAX(CASE WHEN a.hour=6 THEN a.number ELSE 0 END ) hour6_9,
        MAX(CASE WHEN a.hour=9 THEN a.number ELSE 0 END ) hour9_12,
        MAX(CASE WHEN a.hour=12 THEN a.number ELSE 0 END ) hour12_15,
        MAX(CASE WHEN a.hour=15 THEN a.number ELSE 0 END ) hour15_18,
        MAX(CASE WHEN a.hour=18 THEN a.number ELSE 0 END ) hour18_21,
        MAX(CASE WHEN a.hour=21 THEN a.number ELSE 0 END ) hour21_24
        FROM (select DATE_FORMAT(t.ctime,'%m/%d') date,t.groupid hour,
        count(t.historyid) as number from (
        SELECT h.historyid,h.ctime,FLOOR((DATE_FORMAT(h.ctime,'%H')*60)/180)*3 as groupid FROM ck_course_item_history h
        INNER JOIN ck_course_item i ON h.itemid=i.itemid AND i.isdel='0' AND i.status= '1'
        <if test="schoolid != null and schoolid !=''">
            INNER JOIN ck_school_studentinfo ss ON ss.studentid = h.studentid
            AND ss.schoolid  = #{schoolid}
        </if>
        WHERE DATE_FORMAT(h.ctime,'%H')>=6
        AND DATE_FORMAT(h.ctime,'%Y-%m-%d')>=DATE_FORMAT(#{starttime},'%Y-%m-%d')
        AND DATE_FORMAT(#{endtime},'%Y-%m-%d')>=DATE_FORMAT(h.ctime,'%Y-%m-%d')
        <if test="gradeid != null and gradeid != ''">
            AND i.gradeid = #{gradeid}
        </if>
        <if test="subjectid != null and subjectid != ''">
            AND i.subjectid = #{subjectid}
        </if>
        ) t group by DATE_FORMAT(t.ctime,'%Y-%m-%d'),t.groupid
        order by DATE_FORMAT(t.ctime,'%Y-%m-%d'),t.groupid) a GROUP BY a.date
    </select>

    <!-- 查询听课人数 -->
    <select id="statisticsListenNum" resultType="map">
        SELECT
            count(1) value,
            cs.subjectname name
        FROM
            ck_course_item_history cih
            INNER JOIN ck_course c ON c.courseid = cih.courseid
            AND c.isdel = '0'
            <if test="statisticsCo.startDate != null and statisticsCo.startDate != '' and statisticsCo.endDate != null and statisticsCo.endDate != ''">
                and DATE(cih.ctime) between #{statisticsCo.startDate} and #{statisticsCo.endDate}
            </if>
            <if test="statisticsCo.schoolid != null and statisticsCo.schoolid !=''">
                INNER JOIN ck_school_studentinfo ss ON ss.studentid = cih.studentid
                AND ss.schoolid  = #{statisticsCo.schoolid}
            </if>
            INNER JOIN ck_course_subject cs ON cs.subjectid = c.subjectid  and cs.status = '1'
            <if test="statisticsCo.gradeid != null and statisticsCo.gradeid != ''">
                and c.gradeid  = #{statisticsCo.gradeid}
            </if>
        GROUP BY
            c.subjectid
        ORDER BY cs.num + 0
    </select>

    <!--查看单的学生观看信息 -->
    <select id="selectStudentCtime" resultMap="BaseResultMap">
        SELECT
            viewingtime
        FROM
            `ck_course_item_history` cih
        INNER JOIN `ck_course_item` ci  ON ci.itemid = cih.itemid
        AND cih.studentid =#{studentid}
        AND ci.gradeid =#{gradeid}
    </select>

    <!--学生听课数量及课程总数-->
    <select id="selectItimNumber" resultMap="NumberItemVo">
        SELECT
            COUNT(1) studentnumber,
            (
                SELECT
                    COUNT(*)
                FROM
                    ck_course_item
                WHERE
                    gradeid =#{gradeid}
            ) numberall
        FROM
            `ck_course_item` ci
        INNER JOIN ck_course_item_history cih ON ci.itemid = cih.itemid
        AND cih.studentid = #{studentid}
        AND ci.gradeid =#{gradeid}
    </select>
</mapper>
