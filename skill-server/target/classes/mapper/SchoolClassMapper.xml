<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skill.server.mapper.SchoolClassMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.skill.server.entity.pojo.SchoolClass">
        <id column="classid" property="classid" />
        <result column="schoolid" property="schoolid" />
        <result column="gradeid" property="gradeid" />
        <result column="classname" property="classname" />
        <result column="classmemo" property="classmemo" />
        <result column="ctime" property="ctime" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        classid, schoolid, gradeid, classname, classmemo, ctime
    </sql>

    <!--按年级、班级查询班级 -->
    <select id="selectClassList" resultMap="BaseResultMap">
        SELECT
            classid, schoolid, gradeid, classname, classmemo, ctime
        FROM
            `ck_school_class`
        WHERE 1=1
            <if test="schoolid != null and schoolid != ''">
                AND schoolid = #{schoolid}
            </if>
            <if test="gradeid != null and gradeid != ''">
                AND gradeid = #{gradeid}
            </if>
            <if test="teacherid != null and teacherid != ''">
                and classid in (select classid from ck_teach where teacherid = #{teacherid} and  gradeid = ck_school_class.gradeid)
            </if>
        ORDER BY
            classmemo + 0;
    </select>

    <select id="selectClassListCount" resultType="map">
        SELECT
            any_value ( sc.classid ) AS classid,
            any_value ( sc.classname ) AS classname,
            any_value ( sc.classmemo ) AS classmemo,
            any_value ( sg.gradeid ) AS gradeid,
            any_value ( sg.gradename ) AS gradename,
            any_value ( sg.gradememo ) AS gradememo,
            count(1) AS num
        FROM
            ck_school_studentinfo ss
            INNER JOIN ck_school_grade sg ON sg.gradeid = ss.grade
            AND ss.grade = #{params.gradeid}
            AND ss.schoolid = #{params.schoolid}
            <if test="params.position == '1' or params.position == 1">
                <choose>
                    <when test="params.type == '2' or params.type == 2">
                        AND ss.studentclass in (SELECT
                        classid
                        FROM
                        ck_teach
                        WHERE
                        teacherid = #{params.teacherid} and gradeid = #{params.gradeid}
                        AND schoolid = #{params.schoolid}
                        GROUP BY
                        gradeid,
                        schoolid)
                    </when>
                    <otherwise>
                        AND CASE WHEN ( SELECT subjectid FROM ck_teacher_subject WHERE
                        teacherid = #{params.teacherid} AND subjectid = #{params.subjectid}) IS NOT NULL
                        THEN
                        ss.studentclass in (SELECT
                        a.classid
                        FROM
                        (
                        SELECT
                        classid
                        FROM
                        ck_teach
                        WHERE
                        teacherid = #{params.teacherid} and gradeid = #{params.gradeid}
                        AND schoolid = #{params.schoolid}
                        UNION ALL
                        SELECT
                        classid
                        FROM
                        ck_teacher_class
                        WHERE
                        teacherid = #{params.teacherid}) a GROUP BY a.classid)
                        ELSE
                          ss.studentclass IN ( SELECT classid FROM ck_teacher_class WHERE teacherid = #{params.teacherid})
                        END
                    </otherwise>
                </choose>
            </if>
            INNER JOIN ck_school_class sc ON sc.classid = ss.studentclass
        GROUP BY
            sg.gradeid,
            sc.classid
        ORDER BY sg.gradememo + 0, sc.classmemo + 0
    </select>
</mapper>
